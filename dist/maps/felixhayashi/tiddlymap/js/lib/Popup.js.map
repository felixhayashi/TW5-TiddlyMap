{"version":3,"sources":["felixhayashi/tiddlymap/js/lib/Popup.js"],"names":["Popup","parentDomNode","options","_parentDomNode","_domNode","document","createElement","style","display","className","appendChild","$tw","utils","addClass","_isEnabled","_isPreventShowOrHide","_isHideOnClick","hideOnClick","_timeoutShow","_timeoutHide","_isDisplayNoneAfterAnimation","val","parseInt","leavingDelay","_hideDelayLeavingPopup","isInteger","hideDelay","_hideDelay","showDelay","_showDelay","bindTo","_listeners","_handleEnter","_handleLeave","_handleClick","fn","_handleAnimationEnd","convertEventName","setDomListeners","prototype","ev","hide","_hide","isForce","removeClass","_show","signature","text","$tm","mouse","ctrlKey","removeAttribute","removeDOMChildNodes","div","innerHTML","childNodes","length","parRect","getBoundingClientRect","x","clientX","y","clientY","popRect","availSpaceRight","right","width","availSpaceLeft","left","spawnRight","availSpaceBottom","bottom","height","availSpaceTop","top","spawnBottom","shiftLeft","shiftTop","show","delay","_clearTimeouts","setTimeout","setEnabled","isEnabled","isShown","clearTimeout","undefined"],"mappings":"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","file":"../../../../../felixhayashi/tiddlymap/js/lib/Popup.js","sourcesContent":["/* @preserve TW-Guard */\n/*\\\n\ntitle: $:/plugins/felixhayashi/tiddlymap/js/Popup\ntype: application/javascript\nmodule-type: library\n\n@preserve\n\n\\*/\n/* @preserve TW-Guard */\n\n/*** Imports *******************************************************/\n\nimport utils from '$:/plugins/felixhayashi/tiddlymap/js/utils';\n\n/**** Code *********************************************************/\n\n/**\n * Installs a hidden popup below `parentDomNode` that may be shown\n * and or hidden.\n *\n * @constructor\n *\n * @param {Element} [parentDomNode] - The popup container. The\n *    popup will create itself in this container.\n * @param {Hashmap} [options] - An options object.\n * @param {string} [options.className] - A classname to be added to\n *    the popup div.\n * @param {int} [options.delay] - The default delay for the popup\n *    show and hide.\n */\nfunction Popup(parentDomNode, options) {\n\n  options = options || {};\n\n  this._parentDomNode = parentDomNode;\n  this._domNode = document.createElement('div');\n  this._domNode.style.display = 'none';\n  this._domNode.className = 'tmap-popup';\n\n  this._parentDomNode.appendChild(this._domNode);\n  $tw.utils.addClass(this._domNode, options.className);\n\n  this._isEnabled = true;\n  this._isPreventShowOrHide = false;\n  this._isHideOnClick = !!options.hideOnClick;\n  this._timeoutShow = null;\n  this._timeoutHide = null;\n  this._isDisplayNoneAfterAnimation = true;\n\n  // delays\n  let val = parseInt(options.leavingDelay);\n  this._hideDelayLeavingPopup = utils.isInteger(val) ? val : 200;\n\n  val = parseInt(options.hideDelay);\n  this._hideDelay = utils.isInteger(val) ? val : 200;\n\n  val = parseInt(options.showDelay);\n  this._showDelay = utils.isInteger(val) ? val : 200;\n\n  // force early binding of functions to this context\n  utils.bindTo(this, [\n    '_show',\n    '_hide',\n    '_handleEnter',\n    '_handleLeave',\n    '_handleAnimationEnd',\n    '_handleClick'\n  ]);\n\n  // specify handlers\n  this._listeners = {\n    'mouseenter': this._handleEnter,\n    'mouseleave': this._handleLeave,\n    'click': [ this._handleClick, true ]\n  };\n\n  const fn = this._handleAnimationEnd;\n  this._listeners[$tw.utils.convertEventName('animationEnd')] = fn;\n  this._listeners[$tw.utils.convertEventName('transitionEnd')] = fn;\n\n  // add handlers\n  utils.setDomListeners('add', this._domNode, this._listeners, false);\n\n}\n\n/**\n * When the mouse is inside the popup, the popup will manage closing\n * itself and ignore all closing attempts from outside.\n */\nPopup.prototype._handleEnter = function(ev) {\n\n  //~ console.log(\"_handleEnter\");\n\n  this._isPreventShowOrHide = true;\n\n};\n\n/**\n * Handler triggered when leaving the popup div.\n */\nPopup.prototype._handleLeave = function(ev) {\n\n  //~ console.log(\"_handleLeave\");\n\n  this._isPreventShowOrHide = false;\n\n  // we need some delay because resizing may cause the mouse to\n  // exit the popup for some miliseconds\n\n  this.hide(this._hideDelayLeavingPopup);\n\n};\n\nPopup.prototype._handleClick = function(ev) {\n\n  //~ console.log(\"_handleLeave\");\n\n  if (this._isHideOnClick) {\n    this._hide(true);\n  }\n\n};\n\n/**\n * Handler triggered when leaving the popup div.\n */\nPopup.prototype._handleAnimationEnd = function() {\n\n  if (this._isDisplayNoneAfterAnimation) {\n    //~ console.log(\"display: none\");\n    this._domNode.style.display = 'none';\n  }\n\n};\n\n/**\n * Immediately hides the popup.\n */\nPopup.prototype._hide = function(isForce) {\n\n  //~ console.log(\"_hide\");\n\n  if (!isForce && this._isPreventShowOrHide) return;\n\n  //~ console.log(\"_hide SUCCESS\");\n\n  this._isDisplayNoneAfterAnimation = true;\n  this._isPreventShowOrHide = false;\n\n  $tw.utils.removeClass(this._domNode, 'tmap-popup-active');\n\n};\n\n/**\n * Makes the text visible as popup and registers it with the\n * given signature.\n *\n * The popup is spawned on the side that has the most space.\n *\n * @param {*} signature - The signature that has been\n *     passed to {@link show}.\n */\nPopup.prototype._show = function(signature, text) {\n\n  //~ console.log(\"_show\");\n\n  if (this._isPreventShowOrHide || $tm.mouse.ctrlKey || !this._isEnabled) {\n    return;\n  }\n\n  this._domNode.style.display = 'none';\n  $tw.utils.removeClass(this._domNode, 'tmap-popup-active');\n\n  // remove any positioning or modification done before\n  this._domNode.removeAttribute('style');\n\n  // remove any previous content\n  utils.removeDOMChildNodes(this._domNode);\n  var div = this._domNode.appendChild(document.createElement('div'));\n\n  if (typeof text === 'function') {\n    text(signature, div);\n  } else {\n    div.innerHTML = text;\n  }\n\n  if (!div.childNodes.length) return;\n\n  var parRect = this._parentDomNode.getBoundingClientRect();\n  var x = $tm.mouse.clientX;\n  var y = $tm.mouse.clientY;\n\n  //~ console.log(\"_show SUCCESS\");\n\n  // ATTENTION: display needs to be true before we can get the bounds!\n\n  // make sure that display is block so the animation is executed\n  // and we can retrieve the size of the div.\n  this._domNode.style.display = 'block';\n\n  var popRect = this._domNode.getBoundingClientRect();\n\n  var availSpaceRight = parRect.right - (x + popRect.width);\n  var availSpaceLeft = (x - popRect.width) - parRect.left;\n  var spawnRight = availSpaceRight > availSpaceLeft;\n\n  var availSpaceBottom = parRect.bottom - (y + popRect.height);\n  var availSpaceTop = (y - popRect.height) - parRect.top;\n  var spawnBottom = availSpaceBottom > availSpaceTop;\n\n  var shiftLeft = spawnRight ? -15 : popRect.width + 15;\n  var shiftTop = spawnBottom ? -15 : popRect.height + 15;\n\n  this._domNode.style.left = (x - parRect.left - shiftLeft) + 'px';\n  this._domNode.style.top = (y - parRect.top - shiftTop) + 'px';\n\n  // …and make sure that it stays block after the animation is done…\n  this._isDisplayNoneAfterAnimation = false;\n  // …and add the class that triggers the animation…\n  $tw.utils.addClass(this._domNode, 'tmap-popup-active');\n\n};\n\n/**\n * Makes the text visible as popup after a given delay and\n * registers the popup under the specified signature.\n *\n * @param {*} signature - If {@param text} is provided as param and\n *     is a function, then this will be passed later as argument to\n *     text. It therefore acts as means to identify the popup later\n *     on or pass data that survives the delay.\n * @param {string|Function} text - If text\n *     is a string, it will be shown in the popup, otherwise,\n *     if text is a function, it will be executed and it is\n *     expected to populate the popup div passed as second parameter;\n *     the first parameter will be the signature object.\n * @param{delay} delay - Delays the hide operation.\n */\nPopup.prototype.show = function(signature, text, delay) {\n\n  //~ console.log(\"show\", delay);\n\n  this._clearTimeouts();\n\n  delay = (utils.isInteger(delay) ? delay : this._showDelay);\n\n  // start a new timeout\n  this._timeoutShow = setTimeout(this._show, delay, signature, text);\n\n};\n\n/**\n * Hide the popup.\n *\n * @param {int} delay - Delays the hide operation.\n */\nPopup.prototype.hide = function(delay, isForce) {\n\n  //~ console.log(\"hide\", delay);\n\n  this._clearTimeouts();\n\n  delay = (utils.isInteger(delay) ? delay : this._hideDelay);\n\n  if (isForce || delay === 0) { // @TODO is this really correct?\n    this._hide(isForce);\n  } else {\n    this._timeoutHide = setTimeout(this._hide, delay, isForce);\n  }\n\n};\n\n/**\n * Completely enable or disable the popup\n */\nPopup.prototype.setEnabled = function(isEnabled) {\n  this._isEnabled = isEnabled;\n};\n\nPopup.prototype.isShown = function() {\n  return this._domNode.style.display === 'block';\n};\n\nPopup.prototype._clearTimeouts = function() {\n\n  clearTimeout(this._timeoutShow);\n  clearTimeout(this._timeoutHide);\n\n  this._timeoutShow = undefined;\n  this._timeoutHide = undefined;\n\n};\n\n\n/*** Exports *******************************************************/\n\nexport default Popup;\n"],"sourceRoot":"../../../../../../src/plugins"}